#!/bin/bash
# {EXPERIMENT_NAME} - Setup Script
# このスクリプトはtmuxセッションを作成し、{AGENT_COUNT}個のエージェントを起動します

set -e

SESSION_NAME="{EXPERIMENT_ID}"
AGENT_COUNT={AGENT_COUNT}

echo "Setting up {EXPERIMENT_ID}..."
echo "Agent count: $AGENT_COUNT"

# 既存のセッションがあれば削除
tmux has-session -t "$SESSION_NAME" 2>/dev/null && {
  echo "Killing existing session: $SESSION_NAME"
  tmux kill-session -t "$SESSION_NAME"
}

# セッションを作成
tmux new-session -d -s "$SESSION_NAME" -n main

# 追加のエージェント用ペインを作成
# {AGENT_COUNT}個のペインを作成するようにレイアウトを調整
case $AGENT_COUNT in
  2)
    # 左右2分割
    tmux split-window -h -t "$SESSION_NAME:0"
    ;;
  3)
    # 左1:右2（縦分割）
    tmux split-window -h -t "$SESSION_NAME:0"
    tmux split-window -v -t "$SESSION_NAME:0.1"
    ;;
  4)
    # 2x2格子状
    tmux split-window -h -t "$SESSION_NAME:0"
    tmux split-window -v -t "$SESSION_NAME:0.0"
    tmux split-window -v -t "$SESSION_NAME:0.1"
    ;;
  5)
    # 左2:右3
    tmux split-window -h -t "$SESSION_NAME:0"
    tmux split-window -v -t "$SESSION_NAME:0.0"
    tmux split-window -v -t "$SESSION_NAME:0.1"
    tmux split-window -v -t "$SESSION_NAME:0.2"
    ;;
  *)
    # デフォルト: 縦方向に追加
    for ((i=1; i<$AGENT_COUNT; i++)); do
      tmux split-window -v -t "$SESSION_NAME:0"
    done
    ;;
esac

echo ""
echo "✅ Setup complete!"
echo "   Session: $SESSION_NAME"
echo "   Panes: $AGENT_COUNT"
echo ""
echo "Next steps:"
echo "  1. Attach to the session: tmux attach -t $SESSION_NAME"
echo "  2. Start Claude Code in each pane"
echo "  3. Run: ./run.sh"
echo ""
